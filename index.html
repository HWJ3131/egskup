<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>첫 글자 맞히기 영어 퀴즈 (키즈 모드)</title>
<style>
  :root {
    /* 연한 핑크 테마 */
    --bg: #ffd9e6;            /* 전체 배경 */
    --card: #fff2f7;          /* 카드 배경 */
    --text: #4a2b35;          /* 본문 텍스트(짙은 자주색) */
    --muted: #7a5561;         /* 보조 텍스트 */
    --accent: #ff92b2;        /* 포인트 버튼 */
    --accent-press: #ff7aa1;  /* 버튼 눌림 */
    --ok: #1f8a70;
    --bad: #cc3344;
    --radius: 20px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: ui-rounded, system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", "맑은 고딕", sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 16px;
  }
  .app { max-width: 960px; margin: 0 auto; }
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
  }
  h1 {
    margin: 8px 0 12px; font-weight: 900; letter-spacing: -.4px;
    font-size: clamp(22px, 5vw, 32px);
  }
  .row { display: grid; gap: 12px; grid-template-columns: 1fr; }
  @media (min-width: 720px){ .row.two { grid-template-columns: 1fr 1fr; } }
  label { font-size: 16px; color: var(--muted); }
  input[type="text"], select {
    width: 100%; padding: 14px 16px; border-radius: 14px;
    border: 2px solid #ffc0d1; background: #fff; color: var(--text);
    font-size: 18px;
  }
  button {
    appearance: none; border: 0; background: var(--accent); color: #4a2b35;
    font-weight: 800; padding: 14px 18px; border-radius: 14px; cursor: pointer;
    font-size: 18px; touch-action: manipulation;
  }
  button:active { background: var(--accent-press); transform: translateY(1px); }
  button.secondary { background: #ffe1ec; color: var(--text); border: 2px solid #ffc0d1; }

  /* 이미지 더 큼 */
  .quiz-img {
    width: min(80vw, 360px); height: min(80vw, 360px);
    object-fit: cover; border-radius: 20px; border: 3px solid #ffc0d1;
    background: #fff; display: block; margin: 8px auto 12px;
  }

  .word {
    font-size: clamp(28px, 7vw, 40px);
    letter-spacing: 2px; text-align: center; margin: 6px 0 14px;
    font-weight: 900;
  }

  .status {
    display:flex; gap:10px; flex-wrap: wrap; justify-content: center;
    font-size: 16px; color: var(--muted);
  }
  .pill {
    border: 2px solid #ffc0d1; background: #fff; padding: 8px 12px;
    border-radius: 999px; font-weight: 700;
  }

  /* 보기 버튼: 폰트 1.5배(기존 대비), 터치패드 크게 */
  .choices {
    display:grid; gap: 12px; grid-template-columns: 1fr 1fr; margin: 12px 0 4px;
  }
  .choice {
    background:#fff; color: var(--text); border: 3px solid #ffc0d1;
    font-size: clamp(22px, 6.5vw, 28px); /* 크게! */
    padding: 16px 12px; border-radius: 16px;
    min-height: 64px;
  }
  /* 즉시 정답 색상표시 제거 -> 클래스 자체 사용 안 함 */

  .result { font-size: 18px; line-height: 1.6; }
  .ok { color: var(--ok); font-weight: 800; }
  .bad { color: var(--bad); font-weight: 800; }

  .bar {
    height: 8px; border-radius: 999px; background: #ffd1df; overflow: hidden; margin-top: 8px;
  }
  .bar > span { display:block; height:100%; background: #ff92b2; width:0%; transition: width .2s; }
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>첫 글자 맞히기 영어 퀴즈</h1>
    <p style="color:var(--muted); margin-top:-6px">
      사진과 단어를 보고, <b>첫 글자</b>에 해당하는 보기(4지선다)를 눌러요!
    </p>

    <!-- 설정 -->
    <div id="setup">
      <div class="row two">
        <div>
          <label>플레이어 이름</label>
          <input id="playerName" type="text" placeholder="이름을 입력하세요" inputmode="text" />
        </div>
        <div>
          <label>카테고리</label>
          <select id="category">
            <option value="fruits">과일</option>
            <option value="foods">음식</option>
            <option value="sports">운동</option>
            <option value="objects">물건</option>
            <option value="tools">도구</option>
            <option value="plants">식물</option>
            <option value="jobs">직업</option>
            <option value="animals">동물</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap: wrap;">
        <button id="startBtn">퀴즈 시작</button>
        <button class="secondary" id="resetBtn">초기화</button>
      </div>
      <div id="setupError" style="display:none; color:#fff; background:#cc3344; border:2px solid #e07; padding:10px; border-radius:12px; margin-top:8px;"></div>
    </div>

    <!-- 퀴즈 -->
    <div id="quiz" style="display:none; margin-top:16px;">
      <div class="status" style="margin-bottom:8px;">
        <span class="pill">문제 <span id="qIndex">1</span> / <span id="qTotal">10</span></span>
        <span class="pill">이번 문제 시간: <span id="qTime">0.00</span>s</span>
        <span class="pill">총 시간: <span id="totalTime">0.00</span>s</span>
      </div>

      <div class="bar" aria-hidden="true"><span id="progress"></span></div>

      <img id="qImage" class="quiz-img" alt="quiz image" src="">
      <div class="word"><span id="qShown">_pple</span></div>

      <div class="choices">
        <button class="choice" id="ch0" aria-label="첫 글자 선택 1"></button>
        <button class="choice" id="ch1" aria-label="첫 글자 선택 2"></button>
        <button class="choice" id="ch2" aria-label="첫 글자 선택 3"></button>
        <button class="choice" id="ch3" aria-label="첫 글자 선택 4"></button>
      </div>

      <div style="display:flex; gap:8px; justify-content:center; margin-top:6px;">
        <button class="secondary" id="skipBtn">모르겠어요</button>
        <!-- Next 버튼 제거: 자동 진행 -->
      </div>
    </div>

    <!-- 결과 -->
    <div id="result" style="display:none; margin-top:16px;">
      <h2>결과</h2>
      <div class="result" id="resultText"></div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap: wrap;">
        <button id="retryBtn">다시 풀기</button>
      </div>
    </div>
  </div>
</div>

<script>
/** ▼ 연결 설정 ▼
 *  - 같은 Vercel 프로젝트에서 정적 페이지도 서빙한다면: const API_BASE = '';
 *  - GitHub Pages 등 다른 곳에서 호스팅하면: const API_BASE = 'https://<your>.vercel.app';
 */
const API_BASE = '';
const TOTAL_QUESTIONS = 10;

/* DOM */
const $ = (id)=>document.getElementById(id);
const qImage=$('qImage'),qShown=$('qShown'),qIndex=$('qIndex'),qTotal=$('qTotal');
const qTime=$('qTime'),totalTime=$('totalTime'),progress=$('progress');
const choiceBtns=[$('ch0'),$('ch1'),$('ch2'),$('ch3')],skipBtn=$('skipBtn');

let state={playerName:'',category:'fruits',questions:[],idx:0,startAt:0,qStartAt:0,ticker:0,
  perQuestionTimes:[],perQuestionCorrect:[],questionWords:[],questionShown:[],currentChoices:[],currentCorrectLetter:''};

qTotal.textContent = TOTAL_QUESTIONS;

function startTimer(){const tick=()=>{const now=performance.now();
  qTime.textContent=((now-state.qStartAt)/1000).toFixed(2);
  totalTime.textContent=((now-state.startAt)/1000).toFixed(2);
  state.ticker=requestAnimationFrame(tick)};state.ticker=requestAnimationFrame(tick);}
function stopTimer(){if(state.ticker)cancelAnimationFrame(state.ticker);}

function resetAll(){
  stopTimer();
  state={playerName:'',category:'fruits',questions:[],idx:0,startAt:0,qStartAt:0,ticker:0,
    perQuestionTimes:[],perQuestionCorrect:[],questionWords:[],questionShown:[],currentChoices:[],currentCorrectLetter:''};
  $('playerName').value='';$('category').value='fruits';
  setup.style.display='';quiz.style.display='none';result.style.display='none';
  progress.style.width='0%';
}

async function loadQuizSet(category,n=TOTAL_QUESTIONS){
  const url=`${API_BASE}/api/quiz?category=${encodeURIComponent(category)}&n=${n}`;
  const r=await fetch(url);
  if(!r.ok) throw new Error('API_ERROR:'+r.status);
  const d=await r.json();
  if(!d.ok||!d.items) throw new Error(d.error||'API_DATA_ERROR');
  return d.items;
}

function updateProgress(){
  const pct = Math.min(100, Math.round((state.idx)/state.questions.length*100));
  progress.style.width = pct + '%';
}

function showQuestion(){
  updateProgress();
  const q=state.questions[state.idx];
  qImage.src=q.img; qImage.alt=q.word; qShown.textContent=q.shown; qIndex.textContent=(state.idx+1);

  state.questionWords[state.idx]=q.word; state.questionShown[state.idx]=q.shown;
  state.currentChoices=q.choices; state.currentCorrectLetter=q.word[0].toLowerCase();

  choiceBtns.forEach((btn,i)=>{
    btn.textContent=q.choices[i].toUpperCase();
    btn.disabled=false;
    // 누르면 즉시 답 기록 + 다음 문제로 자동 진행 (색상표시/클래스 없음)
    btn.onclick=()=>submitChoiceAndAdvance(q.choices[i]);
  });

  skipBtn.disabled=false;
  state.qStartAt=performance.now();
}

function submitChoiceAndAdvance(letter){
  // 시간/정오만 기록 (즉시 색상표시 없음, 자동 진행)
  state.perQuestionTimes[state.idx]=Math.round(performance.now()-state.qStartAt);
  state.perQuestionCorrect[state.idx]=(letter===state.currentCorrectLetter);

  // 이중 탭 방지: 잠깐 비활성화 후 다음 문제
  choiceBtns.forEach(btn=>btn.disabled=true);
  skipBtn.disabled=true;

  // 아주 짧은 딜레이(아이가 눌렀다는 피드백 느낌)
  setTimeout(nextQuestion, 200);
}

function nextQuestion(){
  state.idx++;
  if (state.idx >= state.questions.length) finishQuiz();
  else showQuestion();
}

function finishQuiz(){
  stopTimer();
  progress.style.width='100%';

  const totalMs=Math.round(performance.now()-state.startAt);
  const correctCount=state.perQuestionCorrect.filter(Boolean).length;
  const wrongCount=state.questions.length - correctCount;
  const accuracy=correctCount/state.questions.length;
  const sec=(ms)=>(ms/1000).toFixed(2);

  // ✅ 최종에서만 정오표 제공 + 발음 버튼 추가
  let wordListHtml='<h3 style="margin-top:6px;">문제별 단어</h3><ul>';
  state.questionWords.forEach((w,idx)=>{
    if(!w) return;
    const mark=state.perQuestionCorrect[idx]?'✅':'❌';
    wordListHtml+=`
      <li style="margin:6px 0;">
        ${mark} ${w}
        <button onclick="speakWord('${w}')" style="
          margin-left:6px; font-size:14px; padding:4px 8px;
          border-radius:8px; border:1px solid #ccc;
        ">🔊</button>
      </li>`;
  });
  wordListHtml+='</ul>';

  $('resultText').innerHTML=`
    <p><b>${state.playerName}</b>의 결과</p>
    <ul>
      <li>카테고리: <b>${state.category}</b></li>
      <li>총 소요시간: <b>${sec(totalMs)}s</b></li>
      <li>정답/오답: <b class="ok">${correctCount}</b> / <b class="bad">${wrongCount}</b></li>
      <li>정답률: <b>${(accuracy*100).toFixed(1)}%</b></li>
    </ul>
    ${wordListHtml}
  `;

  // 저장 로직은 그대로
  const payload={ 
    playerName:state.playerName, category:state.category, totalTimeMs:totalMs,
    perQuestionTimes:state.perQuestionTimes, perQuestionCorrect:state.perQuestionCorrect,
    questionWords:state.questionWords, questionShown:state.questionShown,
    correctCount, wrongCount, accuracy
  };
  fetch(`${API_BASE}/api/save`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  }).then(r=>r.json()).then(j=>console.log('save:', j)).catch(e=>console.error('save error', e));

  quiz.style.display='none'; result.style.display='';
}

// ✅ 발음 기능 함수 추가
function speakWord(word){
  if (!('speechSynthesis' in window)) {
    alert('이 브라우저는 발음을 지원하지 않아요.');
    return;
  }
  const utter = new SpeechSynthesisUtterance(word);
  utter.lang = 'en-US';   // 영어 발음
  utter.rate = 0.9;       // 조금 천천히
  speechSynthesis.speak(utter);
}


/* 시작 */
async function startQuiz(){
  const name=document.getElementById('playerName').value.trim();
  const cat=document.getElementById('category').value;
  if(!name){ alert('이름을 입력하세요'); return; }
  try {
    state.playerName=name; state.category=cat;
    const items=await loadQuizSet(cat,TOTAL_QUESTIONS);
    state.questions=items; state.idx=0; state.startAt=performance.now();
    state.perQuestionTimes=new Array(items.length).fill(0);
    state.perQuestionCorrect=new Array(items.length).fill(false);
    state.questionWords=new Array(items.length).fill('');
    state.questionShown=new Array(items.length).fill('');
    setup.style.display='none'; quiz.style.display=''; result.style.display='none';
    showQuestion(); startTimer();
  } catch(e){
    console.error(e);
    const el=document.getElementById('setupError');
    el.textContent='문제를 불러오지 못했어요. 인터넷 연결/API 상태를 확인해 주세요.';
    el.style.display='';
  }
}

document.getElementById('startBtn').addEventListener('click', startQuiz);
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('retryBtn').addEventListener('click', resetAll);
document.getElementById('skipBtn').addEventListener('click', ()=>{
  // 오답 처리 후 자동 진행
  state.perQuestionTimes[state.idx]=Math.round(performance.now()-state.qStartAt);
  state.perQuestionCorrect[state.idx]=false;
  submitChoiceAndAdvance('__SKIP__');
});
</script>
</body>
</html>


